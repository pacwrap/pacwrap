#!/bin/bash
#
#  PacWrap -- Chroot Invocator
# 
#  Copyright (C) 2023 Xavier R.M. 
#  sapphirus(at)azorium(dot)net
#
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, with only version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.

BOLD=$(tput bold)
RED=$(tput setaf 1)
RESET=$(tput sgr0)
EXEC_NAME="pacwrap-exec"

main () {
	
	parse_args "$@"

	if [[ $SWITCH == v ]]; then
		VER_DISPLAY=$EXEC_NAME pachwrap -v
		exit
	fi

	if [[ $SANDBOX == "" ]]; then
		echo "$EXEC_NAME $BOLD${RED}ERROR$RESET: Target not specified."
		echo "Try 'pacwrap -h' for more information on valid operational parameters."
		exit 1
	fi

	init_vars

	if [[ ! -d $INSTANCE_ROOT ]] || [[ ! -d $INSTANCE_HOME ]]; then
		echo "$EXEC_NAME $BOLD${RED}ERROR$RESET: Sandbox $SANDBOX not found."
		echo "Try 'pacwrap -h' for more information on valid operational parameters."	
		exit 1
	fi

	case $SWITCH in 
		*rc*|*cr*) 
			execute_fakeroot "${ARGS[@]}"	
			;;		
		*rs*|*sr*)	
			execute_fakeroot bash
			;;
		s)
			execute_sandbox bash			
			;;
		*)
			execute_sandbox "${ARGS[@]}"	
			;;
	esac
}

init_vars () {
	INSTANCE_DATA_DIR="$HOME/.local/share/pacwrap"
	INSTANCE_CACHE_DIR="$HOME/.cache/pacwrap/pkg"
	INSTANCE_CONFIG_DIR="$HOME/.config/pacwrap"

	if [[ $PACWRAP_DEBUG ]]; then 
		INSTANCE_DATA_DIR="$PACWRAP_DEBUG"
		INSTANCE_CONFIG_DIR="$PACWRAP_DEBUG/cfg"	
	fi
	
	LOG_FILE="$INSTANCE_DATA_DIR/pacwrap.log"
	INSTANCE_ROOT_DIR=$INSTANCE_DATA_DIR/root
	INSTANCE_HOME_DIR=$INSTANCE_DATA_DIR/home
	INSTANCE_ROOT=$INSTANCE_ROOT_DIR/$SANDBOX
	INSTANCE_HOME=$INSTANCE_HOME_DIR/$SANDBOX
	INSTANCE_USER=user
	INSTANCE_HOME_MOUNT=/home/$INSTANCE_USER
	INSTANCE_SCRIPT="$INSTANCE_CONFIG_DIR/bwrap/$SANDBOX.sh"
}


parse_args () {
	ARGS=()
	local sbdefined=

	for var in "$@"; do
		case $var in 
			--root)
				SWITCH=r$SWITCH
				;;
			--shell)
				SWITCH=s$SWITCH
				;;
			--dep)
				SWITCH=d$SWITCH
				;;	
			--exec)
				SWITCH=rc$SWITCH
				;;
			-E*)
				SWITCH=$(echo $var | cut -c 3-)$SWITCH				
				;;
			*)
				if [[ ! $sbdefined ]]; then 
					SANDBOX=$var
					sbdefined=1
					continue
				fi
				ARGS+=("$var")
				;;
		esac
	done
}

execute_sandbox () {
	if [[ ! -f $INSTANCE_SCRIPT ]]; then
		echo "$EXEC_NAME $BOLD${RED}ERROR$RESET: Script $INSTANCE_SCRIPT not found."
		echo "Try 'pacwrap -h' for more information on valid operational parameters."
		exit 1
	fi
	
	source $INSTANCE_SCRIPT
}

execute_fakeroot() {
	(exec bwrap \
	--bind $INSTANCE_ROOT / \
	--ro-bind /usr/lib/libfakeroot /usr/lib/libfakeroot/ \
	--ro-bind /usr/bin/fakeroot /usr/bin/fakeroot \
	--ro-bind /usr/bin/fakechroot /usr/bin/fakechroot \
	--ro-bind /usr/bin/faked /usr/bin/faked \
	--ro-bind /etc/resolv.conf /etc/resolv.conf \
	--ro-bind $INSTANCE_CONFIG_DIR/pacman/sync/pacman.$SANDBOX.conf /etc/pacman.conf \
	--ro-bind /etc/localtime /etc/localtime \
	--bind $INSTANCE_DATA_DIR/pacman/sync /var/lib/pacman/sync \
	--bind $INSTANCE_DATA_DIR/pacman/gnupg /etc/pacman.d/gnupg \
	--bind $INSTANCE_CACHE_DIR /var/cache/pacman/pkg \
	--dev /dev \
	--proc /proc \
	--tmpfs /tmp \
	--ro-bind $INSTANCE_CONFIG_DIR/pacman/syncdb/pacman.$SANDBOX.conf /tmp/pacman.conf \
	--ro-bind $INSTANCE_CONFIG_DIR/pacman.d/mirrorlist /etc/pacman.d/mirrorlist \
	--bind $LOG_FILE /tmp/pacman.log \
	--bind $INSTANCE_HOME $INSTANCE_HOME_MOUNT \
	--unshare-all \
	--share-net \
	--clearenv \
	--hostname "FakeChroot" \
	--setenv CWD $INSTANCE_HOME_MOUNT \
	--setenv HOME $INSTANCE_HOME_MOUNT \
	--setenv USER $INSTANCE_USER \
	--setenv PATH /usr/bin \
	--setenv TERM xterm \
	--setenv FREETYPE_PROPERTIES $FREETYPE_PROPERTIES \
	--new-session \
	--die-with-parent \
	fakechroot fakeroot "$@")
}

main $@
