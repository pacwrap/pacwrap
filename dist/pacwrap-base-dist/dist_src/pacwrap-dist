#!/bin/bash
#
#  pacwrap - distribution script
# 
#  Copyright (C) 2023 Xavier R.M. 
#  sapphirus(at)azorium(dot)net
#
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, with only version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.

user() {
	if [[ "$(cat /etc/passwd | grep 1000:1000)" ]]; then
		return
	fi

	local uid=$(id -u)
	local gid=$(id -g)

	echo "Creating dummy user.."
	echo "user:x:$uid:$gid::/:/usr/bin/nologin" >> /etc/passwd
	echo "user:x:$gid:" >> /etc/group
}

locale() {
	if [[ -f "/etc/locale.conf" ]]; then
		return
	fi

	echo "Initializing locales.."	
	
	if [[ $LANG == "en_US.UTF-8" ]] || [[ -z "$LANG" ]]; then
		echo -e "\nen_US.UTF-8" >> "$INSTANCE_ROOT/etc/locale.gen"	
	else
		echo -e "\nen_US.UTF-8 UTF-8\n$LANG ${LANG#*.}" >> "$INSTANCE_ROOT/etc/locale.gen"	
	fi

	echo "LANG=$LANG" > "$INSTANCE_ROOT/etc/locale.conf"
	locale-gen
}

dist() {
	locale
	user
	echo "Distribution configuration completed."
}

cert_store() {
	chmod -R 755 /usr/share/ca-certificates /etc/ca-certificates
	
	if [[ $? == 0 ]]; then 
		echo "Applied permissions to certificate stores successfully."
	else
		echo "Error occurred whilst applying permissions to certificate stores."
	fi
}

case $1 in
	cert-store) cert_store;;
	config) dist;;
	*) echo "error: Hook parameter '$1' not found.";;
esac
