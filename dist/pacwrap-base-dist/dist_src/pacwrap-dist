#!/bin/bash
#
#  Pacwrap - distribution script
# 
#  Copyright (C) 2023 Xavier R.M. 
#  sapphirus(at)azorium(dot)net
#
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, with only version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.

user() {
	if [[ "$(cat /etc/passwd | grep 1000:1000)" ]]; then
		return
	fi

	echo "Creating dummy user.."
	echo 'user:x:1000:1000::/:/usr/bin/nologin' >> /etc/passwd
}

locale() {
	if [[ -f "/etc/locale.conf" ]]; then
		return
	fi

	echo "Initializing locales.."	
	
	if [[ $LANG == "en_US.UTF-8" ]] || [[ -z $LANG ]]; then
		echo -e "\nen_US.UTF-8" >> "$INSTANCE_ROOT/etc/locale.gen"	
	else
		echo -e "\nen_US.UTF-8 UTF-8\n$LANG ${LANG#*.}" >> "$INSTANCE_ROOT/etc/locale.gen"	
	fi

	echo "LANG=$LANG" > "$INSTANCE_ROOT/etc/locale.conf"
	locale-gen
}

cleanup() {
	rm /usr/share/libalpm/hooks/0-pacwrap-dist.hook /usr/bin/pacwrap-dist
}

dist() {
	locale
	user
	cleanup
	echo "Distribution configuration completed."
}

dist
